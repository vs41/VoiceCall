<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Stream</title>
</head>
<body>
  <h2>My Webcam</h2>
  <video id="localVideo" autoplay muted playsinline></video>

  <h2>Remote Stream</h2>
  <video id="remoteVideo" autoplay playsinline></video>

  <button onclick="makeCall()">Start Call</button>

  <script>
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');

const peer = new RTCPeerConnection({
  iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
});

const ws = new WebSocket('ws://192.168.1.20:8080'); // Replace with your signaling server IP

// Send ICE candidates to signaling server
peer.onicecandidate = (event) => {
  if (event.candidate) {
    ws.send(JSON.stringify({ type: 'ice', candidate: event.candidate }));
  }
};

// Set remote stream when received
peer.ontrack = (event) => {
  remoteVideo.srcObject = event.streams[0];
};

// Get user media and add tracks to peer connection
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
  .then(stream => {
    localVideo.srcObject = stream;
    stream.getTracks().forEach(track => peer.addTrack(track, stream));
  })
  .catch(error => console.error('Error accessing media devices.', error));

// Handle incoming WebSocket messages with Blob/text handling
ws.onmessage = async (event) => {
  let dataString;

  if (event.data instanceof Blob) {
    dataString = await event.data.text();
  } else {
    dataString = event.data;
  }

  const data = JSON.parse(dataString);

  if (data.type === 'offer') {
    await peer.setRemoteDescription(new RTCSessionDescription(data));
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);
    ws.send(JSON.stringify(peer.localDescription));
  }

  if (data.type === 'answer') {
    await peer.setRemoteDescription(new RTCSessionDescription(data));
  }

  if (data.type === 'ice') {
    try {
      await peer.addIceCandidate(data.candidate);
    } catch (e) {
      console.error('Error adding received ice candidate', e);
    }
  }
};

// Create offer and send to signaling server (run on one peer)
async function makeCall() {
  const offer = await peer.createOffer();
  await peer.setLocalDescription(offer);
  ws.send(JSON.stringify(offer));
}

// Auto-start call after WebSocket connection opens
ws.onopen = () => {
  console.log('âœ… WebSocket connected');
  console.log('ðŸ“ž Making offer...');
  makeCall();
};


  </script>
</body>
</html>
